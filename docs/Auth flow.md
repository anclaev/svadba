# Auth flow

## Содержание

1. Веб-интерфейс
   - Регистрация по персональной ссылке
   - Регистрация через форму
   - Вход через форму
   - Вход через Telegram
     - Telegram привязан
     - Telegram не привязан
2. Telegram-бот
   - Регистрация в боте

## Веб-интерфейс

### Регистрация по персональной ссылке

> Пользователь уже создан в системе, но не подтверждён

1. Пользователь переходит по персональной ссылке
2. Пользователь заполняет анкету гостя и создаёт пароль
3. Пользователю предлагается привязать Telegram

#### Пользователь отказался от привязки Telegram

1. Веб отправляет запрос к API
2. API обрабатывает запрос
3. Пользователь авторизован в вебе (аккаунт подтверждён, Telegram не привязан)

#### Пользователь выбрал привязку Telegram

1. Веб генерирует токен привязки и записывает его в Redis через API
2. Веб редиректит по ссылке в формате: https:/t.me/bot?start=link\_{token}
3. Бот обрабатывает команду /start link\_{token}
4. Пользователь подтверждает привязку в боте
5. Бот обновляет данные через API
6. Веб опрашивает API о статусе привязки по токену
7. Пользователь авторизован в вебе (аккаунт подтверждён, Telegram привязан)

### Регистрация через форму

1. Пользователь заполняет форму
2. Веб отправляет запрос к API
3. API обрабатывает запрос
4. Пользователь авторизован в вебе (аккаунт не подтверждён, Telegram не привязан)

### Вход через форму

1. Пользователь заполняет форму
2. Веб отправляет запрос к API
3. API обрабатывает запрос
4. Пользователь авторизован в вебе (аккаунт не подтверждён, Telegram не привязан)

### Вход через Telegram

1. Веб генерирует одноразовый код и записывает в Redis через API
2. Веб редиректит по ссылке https://t.me/bot?start=login_{code}
3. Бот проверяет код в Redis через API
4. Бот показывает кнопку подтверждения входа
5. Бот отправляет запрос к API о подтверждении входа
6. Веб опрашивает API о статусе входа

#### Telegram привязан

2. По востребованию веба API обрабатывает вход
3. Пользователь авторизован в вебе (аккаунт не подтверждён, Telegram привязан)

#### Telegram не привязан

1. По востребованию веба API возвращает 404 код
2. Веб показывает форму регистрации/входа, зашивая туда telegramId
3. API обрабатывает регистрацию/вход, сразу привязывая telegramId
4. Бот присылает пользователю уведомление об успешной привязке

## Telegram-бот

### Регистрация в боте

1. Пользователь вводит команду /start
2. Бот спрашивает, регистрировался ли пользователь на сайте
3. Бот генерирует токен привязки и записывает его в Redis
4. Бот редиректит по ссылке в формате: https://web/api/auth/telegram/link?token={token}
5. Веб проверяет токен в Redis через API
   - Веб редиректит на страницу входа/регистрации
6. Веб редиректит в бота по ссылке в формате: https://t.me/bot/start=linked_{token}_{userId}
7. Бот показывает сообщение об успешном входе
   - Бот начинает сцену заполнения анкеты, если она не заполнена
   - Бот показывает сообщение, что аккаунт ожидает подтверждения, если он не подтверждён
